<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="2.0">
	<UsingTask AssemblyFile="MSBuild.Community.Tasks.dll" TaskName="RegexMatch" />
  <UsingTask AssemblyFile="MSBuild.Community.Tasks.dll" TaskName="AssemblyInfo" />
	<UsingTask AssemblyFile="MSBuild.Versioning.Tasks.dll" TaskName="AssemblyInfoVersionMatch" />
	<UsingTask AssemblyFile="MSBuild.Versioning.Tasks.dll" TaskName="MercurialVersion" />
	
	<Target Name="BeforeCompile">
		<MercurialVersion RepositoryPath="$(SolutionDir)">
			<Output TaskParameter="MercurialChangesetId" PropertyName="MercurialChangesetId" />
			<Output TaskParameter="MercurialLocalRevNumber" PropertyName="MercurialLocalRevNumber" />
			<Output TaskParameter="MercurialLocalRevNumber" PropertyName="BuildNumber" />
		</MercurialVersion>
		
		<RegexMatch Input="$(MercurialLocalRevNumber)" Expression="\+">
			<Output TaskParameter="Output" PropertyName="IsDirty" />
		</RegexMatch>
		
		<CreateProperty Value="0" Condition="$(IsDirty) != ''">
			<Output TaskParameter="Value" PropertyName="BuildNumber" />
		</CreateProperty>
		
		<PropertyGroup>
			<VersionInfoPath>$(MSBuildProjectDirectory)\Properties\VersionInfo.cs</VersionInfoPath>
			<VersionString>0.1.0.$(BuildNumber)</VersionString>
			<InformationalVersionString>$(MercurialChangesetId) (buildrev $(MercurialLocalRevNumber)) (hg)</InformationalVersionString>
		</PropertyGroup>
		
		<AssemblyInfoVersionMatch 
			MatchVersion="$(VersionString)" 
			MatchInformationalVersion="$(InformationalVersionString)" 
			VersionFile="$(VersionInfoPath)">
			<Output TaskParameter="Matches" PropertyName="UpToDateVersionInfo" />
		</AssemblyInfoVersionMatch>

		<AssemblyInfo CodeLanguage="CS"
			OutputFile="$(MSBuildProjectDirectory)\Properties\VersionInfo.cs"
			AssemblyVersion="$(VersionString)"
			AssemblyInformationalVersion="$(InformationalVersionString)"
			Condition="!$(UpToDateVersionInfo)" />
			
		<CreateItem Include="$(MSBuildProjectDirectory)\Properties\VersionInfo.cs">
			<Output TaskParameter="Include" ItemName="Compile" />
		</CreateItem>
	</Target>
</Project>